{% extends "base.html" %} 

{% block title %}{{ vendor_name }} {{ _('api_Operations') }} {% endblock %} 

{% block extra_css %}
<style>
  .tab-pane {
    padding: 20px;
    border-left: 1px solid #dee2e6;
    border-right: 1px solid #dee2e6;
    border-bottom: 1px solid #dee2e6;
    border-radius: 0 0 5px 5px;
  }
  .endpoint-info {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
  }
  .param-row {
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 5px;
  }
  .response-pre {
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 500px;
    overflow-y: auto;
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    border: 1px solid #e9ecef;
  }
  .iccid-input-group {
    display: flex;
    gap: 10px;
  }
  .iccid-input-group .form-control {
    flex: 1;
  }
  .check-digit-btn {
    white-space: nowrap;
  }
</style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <h2>{{ vendor_name }} {{ _('api_Operations') }}</h2>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="single-tab"
          data-bs-toggle="tab"
          data-bs-target="#single"
          type="button"
          role="tab"
        >
          <i class="bi bi-play-circle"></i> {{ _('single_request') }}
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="batch-tab"
          data-bs-toggle="tab"
          data-bs-target="#batch"
          type="button"
          role="tab"
        >
          <i class="bi bi-collection-play"></i> {{ _('batch_processing') }}
        </button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <!-- 批量处理标签页 -->
      <div class="tab-pane fade" id="batch" role="tabpanel">
        <div class="alert alert-info">
          <h5>{{ _('batch_title') }}</h5>
          <p>{{ _('montnet_batch_description') }}</p>
          <ul>
              <li><strong>endpoint</strong>: {{ _('api_endpoint') }}</li>
              <li><strong>imsi</strong>: {{ _('imsi_number_or_range') }}</li>
              <li>{{ _('other_required_parameters') }}</li>
          </ul>
          <p>{{ _('montnet_batch_note') }}</p>
          <!-- 添加模板下载按钮 -->
          <div class="mt-3">
              <a href="/api/template/montnet" class="btn btn-success">
                  <i class="bi bi-download"></i> {{ _('download_template') }}
              </a>
              <small class="text-muted ms-2">{{ _('template_note') }}</small>
          </div>          
        </div>

        <form id="batchForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="batchFile" class="form-label">{{ _('select_Excel_File') }}</label>
            <input
              class="form-control"
              type="file"
              id="batchFile"
              name="file"
              accept=".xlsx,.xls"
            />
          </div>

          <div class="mb-3">
              <label for="delay" class="form-label">{{ _('request_interval') }}</label>
              <input type="number" class="form-control" id="delay" name="delay" value="0.5" step="0.1" min="0">
              <div class="form-text">{{ _('request_interval_note') }}</div>
          </div>

          <button type="submit" class="btn btn-primary">
            <i class="bi bi-play-fill"></i> {{ _('start_processing') }}
          </button>
        </form>

        <div id="batchLoading" class="mt-3" style="display: none">
          <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status">
              <span class="visually-hidden">{{ _('loading') }}</span>
            </div>
            {{ _('processing_please_wait') }}
          </div>
        </div>

        <div id="batchResult" class="mt-3" style="display: none">
          <div class="alert alert-success">
            <h5>{{ _('process_completed') }}</h5>
            <p id="batchResultMessage"></p>
            <p>
              {{ _('result_file_generated') }}<a
                id="downloadLink"
                href="#"
                class="btn btn-success btn-sm"
                >{{ _('click_to_download') }}</a
              >
            </p>
          </div>
        </div>
      </div>

      <!-- 单条请求标签页 -->
      <div class="tab-pane fade show active" id="single" role="tabpanel">
        <div class="alert alert-info">
            <h5>{{ _('single_title') }}</h5>
            <p>{{ _('montnet_single_description') }}</p>
            <p><strong>{{ _('note') }}:</strong> {{ _('montnet_single_note') }}</p>
            <p><strong>{{ _('montnet_iccid_note') }}</strong></p>
        </div>

        <form id="singleForm">
          <div class="mb-3">
            <label for="endpoint" class="form-label">{{ _('api_endpoint') }}</label>
            <select class="form-select" id="endpoint" name="endpoint" required>
              <option value="">{{ _('select_endpoint') }}</option>
              {% for endpoint in endpoints %}
              <option value="{{ endpoint }}">{{ endpoint }}</option>
              {% endfor %}
            </select>
          </div>

          <div id="endpointInfo" class="endpoint-info" style="display: none">
            <h6>{{ _('enpoint_info') }}</h6>
            <p id="endpointDescription"></p>
          </div>

          <div id="paramsContainer">
            <!-- 参数将在这里动态生成 -->
          </div>

          <button type="submit" class="btn btn-primary d-block mt-3">
            <i class="bi bi-send"></i> {{ _('send_request') }}
          </button>
        </form>

        <div id="singleResult" class="mt-3" style="display: none">
          <div class="card">
            <div class="card-header">{{ _('response_result') }}</div>
            <div class="card-body">
              <pre id="responseContent" class="response-pre"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  var montnetEndpointInfo = {
      heartbeat: "{{ _('montnet_endpoint_heartbeat') }}",
      qrysub: "{{ _('montnet_endpoint_qrysub') }}",
      qrypacklist: "{{ _('montnet_endpoint_qrypacklist') }}",
      queryQosQuota: "{{ _('montnet_endpoint_queryQosQuota') }}",
      addpack: "{{ _('montnet_endpoint_addpack') }}",
      delpack: "{{ _('montnet_endpoint_delpack') }}",
      "quota/topup": "{{ _('montnet_endpoint_quota_topup') }}",
      suspend: "{{ _('montnet_endpoint_suspend') }}",
      recover: "{{ _('montnet_endpoint_recover') }}",
      qryLocation: "{{ _('montnet_endpoint_qryLocation') }}"
  };

  // 计算ICCID校验位
  function calculateICCIDCheckDigit(iccid) {
    // 移除所有非数字字符
    var cleanICCID = iccid.replace(/\D/g, '');
    
    if (cleanICCID.length !== 19) {
        throw new Error("{{ _('montnet_iccid_must_be_19_digits') }}");
    }
    
    var sum = 0;
    
    // 从左到右处理每一位
    for (var i = 0; i < 19; i++) {
        var digit = parseInt(cleanICCID.charAt(i), 10);
        
        // 奇数位（从1开始计数，索引0对应第1位）
        if ((i + 1) % 2 === 1) {
            // INT(值*2/10) + MOD(值*2,10)
            var doubled = digit * 2;
            var calculated = Math.floor(doubled / 10) + (doubled % 10);
            sum += calculated;
        } else {
            // 偶数位直接取值
            sum += digit;
        }
    }
    
    // MOD(值*9,10)
    var checkDigit = (sum * 9) % 10;
    return checkDigit;
  }

  // 验证ICCID格式
  function validateICCID(iccid) {
    // 移除所有非数字字符
    var cleanICCID = iccid.replace(/\D/g, '');
    
    if (cleanICCID.length === 19) {
        return {
            valid: true,
            length: 19,
            message: "{{ _('montnet_iccid_19_digits_note') }}"
        };
    } else if (cleanICCID.length === 20) {
        return {
            valid: true,
            length: 20,
            message: "{{ _('montnet_iccid_20_digits_note') }}"
        };
    } else {
        return {
            valid: true,
            length: cleanICCID.length,
            message: "{{ _('montnet_iccid_19_or_20_digits') }}"
        };
    }
  }

  $(document).ready(function () {
    // 端点选择变化事件
    $("#endpoint").change(function () {
      var endpoint = $(this).val();

      // 清除之前的响应结果
      $("#singleResult").hide();
      $("#responseContent").text("");

      if (endpoint) {
        $("#endpointInfo").show();
        $("#endpointDescription").text(
          montnetEndpointInfo[endpoint] || "{{ _('no_description_available') }}"
        );

        // 清空参数容器
        $("#paramsContainer").empty();

        // 通过AJAX获取端点参数
        $.ajax({
          url: "/api/montnet/endpoint/" + encodeURIComponent(endpoint) + "/params",
          type: "GET",
          success: function (params) {
            if (params.length === 0) {
              $("#paramsContainer").append(
                '<div class="alert alert-info">{{ _("montnet_no_extra_params") }}</div>'
              );
            } else {
              // 为每个参数创建输入框
              params.forEach(function (param) {
                var isICCID = param.name.toLowerCase() === 'iccid';
                
                var paramRow = `
                            <div class="param-row mb-3">
                                <label for="param_${param.name}" class="form-label">${param.name} ${param.required ? '<span class="text-danger">*</span>' : ''}</label>
                                <small class="form-text text-muted d-block">${param.description}</small>
                                ${isICCID ? 
                                  `<div class="iccid-input-group">
                                    <input type="text" 
                                           class="form-control" 
                                           id="param_${param.name}" 
                                           name="${param.name}" 
                                           ${param.required ? "required" : ""}
                                           placeholder="{{ _('montnet_enter_iccid_placeholder') }}"
                                           maxlength="20">
                                    <button type="button" class="btn btn-outline-secondary check-digit-btn" id="calculateCheckDigit">
                                      <i class="bi bi-calculator"></i> {{ _('montnet_calculate_check_digit') }}
                                    </button>
                                   </div>
                                   <div class="form-text" id="iccidValidationMessage"></div>` :
                                  `<input type="text" 
                                         class="form-control" 
                                         id="param_${param.name}" 
                                         name="${param.name}" 
                                         ${param.required ? "required" : ""}
                                         placeholder="{{ _('enter_parameter_value') }} ${param.name}">`
                                }
                            </div>`;
                $("#paramsContainer").append(paramRow);

                // 如果是ICCID输入框，添加事件监听
                if (isICCID) {
                  var inputElement = $(`#param_${param.name}`);
                  var messageElement = $('#iccidValidationMessage');
                  
                  // 实时验证ICCID格式
                  inputElement.on('input', function() {
                      var validation = validateICCID($(this).val());
                      if (validation.valid) {
                          if (validation.length === 19) {
                              // 19位ICCID显示为蓝色提示
                              messageElement.removeClass('text-danger text-success').addClass('text-primary').text(validation.message);
                          } 
                          else if (validation.length === 20) {
                              // 20位ICCID显示为绿色成功
                              messageElement.removeClass('text-danger text-primary').addClass('text-success').text(validation.message);                            
                          } 
                          else {
                              // 其余显示为红色错误
                              messageElement.removeClass('text-success text-primary').addClass('text-danger').text(validation.message);
                          }
                      }
                  });

                  // 计算Check Digit按钮点击事件
                  $('#calculateCheckDigit').on('click', function() {
                    var currentValue = inputElement.val().replace(/\D/g, '');
                    var validation = validateICCID(currentValue);
                    
                    if (!validation.valid) {
                      alert('{{ _("montnet_enter_valid_19_digits") }}');
                      return;
                    }
                    
                    if (validation.length === 19) {
                      var checkDigit = calculateICCIDCheckDigit(currentValue);
                      var fullICCID = currentValue + checkDigit;
                      inputElement.val(fullICCID);
                      messageElement.removeClass('text-danger').addClass('text-success').text('{{ _("montnet_check_digit_calculated") }}: ' + fullICCID);
                    } else if (validation.length === 20) {
                      alert('{{ _("montnet_iccid_already_20_digits") }}');
                    }
                  });
                }
              });
            }
          },
          error: function (xhr) {
            $("#paramsContainer").append(
              '<div class="alert alert-danger">{{ _("montnet_get_params_failed") }}: ' +
                (xhr.responseJSON ? xhr.responseJSON.error : "{{ _('unknown_error') }}") +
                "</div>"
            );
          },
        });
      } else {
        $("#endpointInfo").hide();
        $("#paramsContainer").empty();
      }
    });

    // 批量处理表单提交
    $('#batchForm').on('submit', function(e) {
        e.preventDefault();
        
        // 获取并处理delay值
        var delayInput = $('#delay').val();
        var delayValue = delayInput === '' ? 0 : parseFloat(delayInput);
        
        // 确保delay值是非负数
        if (isNaN(delayValue) || delayValue < 0) {
            alert('{{ _("request_interval_non_negative") }}');
            return;
        }
        
        // 显示加载中状态
        $('#batchLoading').show();
        $('#batchResult').hide();
        
        // 创建FormData并设置处理后的delay值
        var formData = new FormData(this);
        formData.set('delay', delayValue);
        
        $.ajax({
            url: '/api/montnet/batch',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    // 创建下载链接
                    var downloadUrl = '/api/download/montnet/' + encodeURIComponent(response.filename);
                    $('#downloadLink').attr('href', downloadUrl);
                    $('#batchResultMessage').text(response.message);
                    $('#batchResult').show();
                } else {
                    alert('{{ _("processing_failed") }}: ' + response.error);
                }
                
                // 隐藏加载中状态
                $('#batchLoading').hide();
            },
            error: function(xhr) {
                alert('{{ _("processing_failed") }}: ' + (xhr.responseJSON ? xhr.responseJSON.error : '{{ _("unknown_error") }}'));
                // 隐藏加载中状态
                $('#batchLoading').hide();
            }
        });
    });

    // 单条请求表单提交
    $("#singleForm").on("submit", function (e) {
      e.preventDefault();

      // 检查ICCID格式
      var iccidInput = $('#param_iccid');
      if (iccidInput.length > 0) {
        var iccidValue = iccidInput.val();
        var validation = validateICCID(iccidValue);
        if (!validation.valid) {
          alert(validation.message);
          return;
        }
      }

      // 清除之前的响应结果
      $("#singleResult").hide();
      $("#responseContent").text("");

      // 构建参数对象
      var params = {
        endpoint: $("#endpoint").val(),
      };

      // 获取所有参数
      $("#paramsContainer input").each(function () {
        var name = $(this).attr("name");
        var value = $(this).val();

        if (name && value) {
          params[name] = value;
        }
      });

      // 发送请求
      $.ajax({
        url: "/api/montnet/single",
        type: "POST",
        data: params,
        success: function (response) {
          try {
            // 尝试解析响应，如果是字符串形式的JSON，则解析它
            let parsedResponse = response;
            if (typeof response === "string") {
              try {
                parsedResponse = JSON.parse(response);
              } catch (e) {
                // 如果不是有效的JSON，保持原样
              }
            }

            // 格式化显示
            $("#responseContent").text(JSON.stringify(parsedResponse, null, 2));
          } catch (e) {
            // 如果出现错误，显示原始响应
            $("#responseContent").text(
              typeof response === "object"
                ? JSON.stringify(response, null, 2)
                : response
            );
          }
          $("#singleResult").show();
        },
        error: function (xhr) {
          $("#responseContent").text(
            "{{ _('error') }}: " + (xhr.responseJSON ? xhr.responseJSON.error : "{{ _('unknown_error') }}")
          );
          $("#singleResult").show();
        },
      });
    });
  });
</script>
{% endblock %}